<!DOCTYPE html>
<meta charset="utf-8">
<style> /* set the CSS */
body 
{background: white
}


{
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  font-family: Montserrat, sans-serif;
  font-wight: 500;
  font-size: 12px;
}

.root {
  display: flex;
}

.axis text {
  font-weight: bold;
}

.y-axis text {
  text-anchor: end;
}

.axis path {
  display: none;
}

.axis line {
  stroke-opacity: 0.3;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 1.5px;
}

.legend-item {
  cursor: pointer;
}

.legend-item:hover {
  text-decoration: underline;
}

.extra-options-container {
  font-size: 12px;
  margin-top: 5px;
  display: flex;
  width: 100px;
  margin-left: 57px;
  justify-content: space-between;
}

.hide-all-option, .show-all-option {
  text-decoration: underline;
  cursor: pointer;
}

.hide-all-option:hover, .show-all-option:hover {
  text-decoration: none;
}

.voronoi path {
  fill: none;
  pointer-events: all;
}

.voronoi-show path {
  stroke: red;
  stroke-opacity: 0.2;
}

.region-hover {
  stroke: #000;
  stroke-width: 4px;
}

.actions {
  display: flex;
  width: 681px;
  padding-left: 49px;
  justify-content: space-between;
}

.header {
  display: flex;
  padding-bottom: 10px;
  margin-bottom: 10px;
}

.title {
  padding-right: 40px;
  margin: 0;
  font-weight: 500;
  font-size: 26px;
  line-height: 27px;
  margin-top: 21px;
  padding-left: 48px;
  width: 718px;
  box-sizing: border-box;
}

.preview {
  position: relative;
}

.preview-rect {
  position: absolute;
  left: 0;
  top: 0;
}

.preview-axis.x-axis .tick:nth-child(2) text {
  text-anchor: start;
}

.preview-axis.x-axis .tick:nth-child(3) text {
  text-anchor: end;
}



</style>
<body>

<!-- load the d3.js library -->    
<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vega@4.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-lite@3.0.0-rc6"></script>
<script src="https://cdn.jsdelivr.net/npm/vega-embed@3.19.2"></script>


<h1> El calentamiento global es una realidad</h1>




<ul>
<li>Universidad de los Andes</li>
<li>Maestría en ingeniería de información </li>
<li>Visual analytics</li>
<li>Autor: <a target="_blank" href="https://www.linkedin.com/in/harry-cristhian-torres-moreno-5bb53370/">Harry Cristhian Torres Moreno</a> </li>
<li>Código: 201727422 </li>



</ul>

<hr/>


<h2> Introducción</h2>
<p>
Los glaciares se están derritiendo, los niveles del mar están subiendo, los grandes bosque se están muriendo y la vida silvestre está luchando para adaptarse al cambio. Es claro que el calentamiento global es causado por los seres humanos al liberar gases que atrapan el calor, estos gases llamados gases de efecto invernadero han crecido de manera considerable y sus niveles son ahora los más altos con relación a los últimos 650 mil años.</p>
<p>
Teniendo en cuenta lo anterior, un cliente está interesado sobre el estudio de calentamiento global y menciona: "necesito que diseñes una visualización que eduque a la gente acerca del calentamiento global. Quiero que a todo el mundo le quede claro que el calentamiento global es una realidad de todo el planeta, y que la evidencia muestra que en los últimos años se ha venido presentando un incremento constante de la temperatura. Acabo de verme la serie Cosmos y me explicaron allí que a pesar que si se mira un fenómeno como la temperatura, a pesar que se encuentren pequeños decrementos entre meses, el comportamiento general agregando por años se va a ver en crecimiento. Quiero que me hagas una visualización interactiva, que descreste a la gente, que sea novedosa y fácil de entender, y sobre todo que muestre ese comportamiento global"
</p>
 </a>

<h2> Metodología </h2>
<ul>
  <li> <strong>Datos:</strong> Teniendo en cuenta el objetivo que quiere alcanzar el cliente, se procede a utilizar un conjunto de datos obtenidos de la National Aeronautics and Space Administration Goddard Institute for Space Studies ( <a target="_blank" href="https://data.giss.nasa.gov/gistemp/"> NASA) </a> que muestra una estimación de la media de la temperatura a nivel mundial, en el hemisferio norte y en el hemisferio sur desde el año 1880 hasta el año  2018. </li>
  <li> <strong>Procesamiento de los datos: </strong> Los datos fueron procesados en python, así mismo, cada una de las temperaturas se dividió por 100 para obtener una medida en grados celsius. </li>
  <li> <strong>Visualización: </strong> Para seleccionar la mejor visualización teniendo en cuenta el principio de expresividad y eficiencia, se utilizó como metodología el framework de Tamara (Tamara Munzner: Visualization Analysis and Design AK Peters 2014.) </li>
  <li> <strong> Herramientas </strong>
    <ul>
    <li>Anaconda-Spyder, Python</li>
    <li>Text Sublime, HTML, CSS, Javascript D3 v5.0</li>
    <li>GitHub para el desplegue de la página </li>
  </ul>
</li>    


</ul>

<h2> Visualización</h2>
<p> 
A continnuación se presenta una visualización interactiva (por medio de un gráfico de líneas)  que permite identificar la tendencia creciente que ha venido presentando la temperatura a nivel mundial, en el hemisferio norte y en el hemisferio sur a travé de un gráfico de líneas desde el año 1880 hasta el año 2018, así mismo, se presenta la caracterización de esta visualización en función del framework de Tamara (what, why y how) </p>
<h3> Caracterización What, Why How </h3>

<ul>
    <li> <strong>What</strong> 
        <ul> 
            <li> <strong>Tipo de conjunto de datos: </strong> Temporal </li>
            <li> <strong> Atributos </strong> Los atributos son:
                <ol> 
                    <li> <strong>Temperatura:</strong> Correponde la temperatura promedio y medida en grados celsius, esta es una variable cuantitativa y divergente</li>
                    <li> <strong>Región: </strong> Es una variable categórica, y permite identificar si la temperatura promedio corresponde al hemisferio norte (HN), al hemisferio sur (HS) o si es a nivel mundial (Global)</li>
                    <li><strong> Fecha: </strong> Corresponde a la fecha en la cual se midió la temperatura, esta variable es cuantitativa y divergente (se tomará en cuenta el año).</li> 
                </ol>
            </li>
        </ul>
    </li>
    

    <li> <strong> Why </strong>
        <ol>
            <li> <strong>Tarea 1: </strong> Sumarizar la tendencia que ha venido presentando la temperatura desde el año 1880  hasta el año 2018 (Tamara: 
summarize, Trends)  </li>
        </ol>
    </li>


    <li><strong>How </strong>
        <ol>
            <li><strong>Marcas: </strong></li>
                 <ol>
                  <li><strong>Línea</strong>: Cada línea representa la temperatura promedio a nivel mundial, en el hemisferio norte y en el hemisferio sur. </li>
                 </ol>
            <li> <strong>Canales:</strong> 
                <ol>
                    <li><strong>Color hue:</strong> Cada línea se puede distinguir mediante un color distinto.</li>
                    <li><strong> Posición eje x, express: </strong> El atributo fecha se encuentra ubicado sobre el eje x </li>
                    <li> <strong> Posición eje y, express: </strong> El atributo Temperatura ppromedio se encuentra ubicado en el eje y</li>
               </ol>
            </li>
        </ol>
        <li> <strong> Interacción: </strong> Es posible realizar un zoom sobre el gráfico para poder observar más detalle un periodo de interés, así mismo, es posible ocultar (o mostrar) la temperatura de una región en particular (a nivel mundial, hemisferior norte y hemisferio sur), en el video adjunto a este trabajo se explica la interacción del gráfico.</li>   
    </li>


</ul>



<div class="actions">


  <button class="reset-zoom-button">Reset zoom</button>
</div>
<div class="root">
  <div class="chart"></div>
  <div class="legend"></div>
</div>

<script>

d3.csv('https://raw.githubusercontent.com/hctorresm/El-calentamiento-global-es-un-hecho/master/data510.csv').then(data => draw(data))

const ENABLED_OPACITY = 1;
const DISABLED_OPACITY = .2;

const timeFormatter = d3.timeFormat('%d-%m-%Y');

////const timeFormatter = d3.timeFormat('%d-%m-%Y');

function draw(data) {
  const margin = { top: 20, right: 20, bottom: 50, left: 50 };
  const width = 750 - margin.left - margin.right;
  const height = 420 - margin.top - margin.bottom;

  const x = d3.scaleTime()
    .range([0, width]);

  const y = d3.scaleLinear()
    .range([height, 0]);

  let rescaledX = x;
  let rescaledY = y;

  const colorScale = d3.scaleOrdinal()
    .range([
      '#4c78a8',
      '#9ecae9',
      '#f58518'
    ]);

  const chartAreaWidth = width + margin.left + margin.right;
  const chartAreaHeight = height + margin.top + margin.bottom;

  const zoom = d3.zoom()
    .scaleExtent([1, 10])
    .translateExtent([[0, 0], [chartAreaWidth, chartAreaHeight]])
    .on('start', () => {
      hoverDot
        .attr('cx', -5)
        .attr('cy', 0);
    })
    .on('zoom', zoomed);

  const svg = d3.select('.chart')
    .append('svg')
    .attr('width', width + margin.left + margin.right)
    .attr('height', height + margin.top + margin.bottom)
    .append('g')
    .attr('transform', `translate(${ margin.left },${ margin.top })`);

  data.forEach(function (d) {
    d.date = new Date(d.date);
    d.percent = +d.percent;
  });

  //x.domain(d3.extent(data, d => d.date));
x.domain([d3.min(data, d => d.date)   , d3.max(data, d => d.date)]);

  y.domain([d3.min(data, d => d.percent)   , d3.max(data, d => d.percent)]);
  colorScale.domain(d3.map(data, d => d.regionId).keys());

  const xAxis = d3.axisBottom(x)
    .ticks((width + 2) / (height + 2) * 5)
    .tickSize(-height - 6)
    .tickPadding(10);

  const yAxis = d3.axisRight(y)
    .ticks(5)
    .tickSize(7 + width)
    .tickPadding(-11 - width)
    .tickFormat(d => d );  ////+ '%');  ////no en porcentaje

  const xAxisElement = svg.append('g')
    .attr('class', 'axis x-axis')
    .attr('transform', `translate(0,${ height + 6 })`)
    .call(xAxis);

  const yAxisElement = svg.append('g')
    .attr('transform', 'translate(-7, 0)')
    .attr('class', 'axis y-axis')
    .call(yAxis);

  svg.append('g')
    .attr('transform', `translate(0,${ height })`)
    .call(d3.axisBottom(x).ticks(0));

  svg.append('g')
    .call(d3.axisLeft(y).ticks(0));

  svg.append('defs').append('clipPath')
    .attr('id', 'clip')
    .append('rect')
    .attr('width', width)
    .attr('height', height);

  const nestByRegionId = d3.nest()
    .key(d => d.regionId)
    .sortKeys((v1, v2) => (parseInt(v1, 10) > parseInt(v2, 10) ? 1 : -1))
    .entries(data);

  const regionsNamesById = {};

  nestByRegionId.forEach(item => {
    regionsNamesById[item.key] = item.values[0].regionName;
  });

  const regions = {};

  d3.map(data, d => d.regionId)
    .keys()
    .forEach((d, i) => {
      regions[d] = {
        data: nestByRegionId[i].values,
        enabled: true
      };
    });

  const regionsIds = Object.keys(regions);

  const lineGenerator = d3.line()
    .x(d => rescaledX(d.date))
    .y(d => rescaledY(d.percent));

  const nestByDate = d3.nest()
    .key(d => d.date)
    .entries(data);

  const percentsByDate = {};

  nestByDate.forEach(dateItem => {
    percentsByDate[dateItem.key] = {};

    dateItem.values.forEach(item => {
      percentsByDate[dateItem.key][item.regionId] = item.percent;
    });
  });

  const legendContainer = d3.select('.legend');

  const legendsSvg = legendContainer
    .append('svg');

  const legendsDate = legendsSvg.append('text')
    .attr('visibility', 'hidden')
    .attr('x', 0)
    .attr('y', 10);

  const legends = legendsSvg.attr('width', 210)
    .attr('height', 373)
    .selectAll('g')
    .data(regionsIds)
    .enter()
    .append('g')
    .attr('class', 'legend-item')
    .attr('transform', (regionId, index) => `translate(0,${ index * 20 + 20 })`)
    .on('click', clickLegendHandler);

  const legendsValues = legends
    .append('text')
    .attr('x', 0)
    .attr('y', 10)
    .attr('class', 'legend-value');

  legends.append('rect')
    .attr('x', 58)
    .attr('y', 0)
    .attr('width', 12)
    .attr('height', 12)
    .style('fill', regionId => colorScale(regionId))
    .select(function() { return this.parentNode; })
    .append('text')
    .attr('x', 78)
    .attr('y', 10)
    .text(regionId => regionsNamesById[regionId])
    .attr('class', 'legend-text')
    .style('text-anchor', 'start');

  const extraOptionsContainer = legendContainer.append('div')
    .attr('class', 'extra-options-container');

  extraOptionsContainer.append('div')
    .attr('class', 'hide-all-option')
    .text('hide all')
    .on('click', () => {
      regionsIds.forEach(regionId => {
        regions[regionId].enabled = false;
      });

      singleLineSelected = false;

      redrawChart();
    });

  extraOptionsContainer.append('div')
    .attr('class', 'show-all-option')
    .text('show all')
    .on('click', () => {
      regionsIds.forEach(regionId => {
        regions[regionId].enabled = true;
      });

      singleLineSelected = false;

      redrawChart();
    });

  const linesContainer = svg.append('g')
    .attr('clip-path', 'url(#clip)');

  let singleLineSelected = false;

  const voronoi = d3.voronoi()
    .x(d => x(d.date))
    .y(d => y(d.percent))
    .extent([[0, 0], [width, height]]);

  const hoverDot = svg.append('circle')
    .attr('class', 'dot')
    .attr('r', 3)
    .attr('clip-path', 'url(#clip)')
    .style('visibility', 'hidden');

  let voronoiGroup = svg.append('g')
    .attr('class', 'voronoi-parent')
    .attr('clip-path', 'url(#clip)')
    .append('g')
    .attr('class', 'voronoi')
    .on('mouseover', () => {
      legendsDate.style('visibility', 'visible');
      hoverDot.style('visibility', 'visible');
    })
    .on('mouseout', () => {
      legendsValues.text('');
      legendsDate.style('visibility', 'hidden');
      hoverDot.style('visibility', 'hidden');
    });

  d3.select('.voronoi-parent').call(zoom);

  d3.select('.reset-zoom-button').on('click', () => {
    rescaledX = x;
    rescaledY = y;

    d3.select('.voronoi-parent').transition()
      .duration(750)
      .call(zoom.transform, d3.zoomIdentity);
  });

  d3.select('#show-voronoi')
    .property('disabled', false)
    .on('change', function () {
      voronoiGroup.classed('voronoi-show', this.checked);
    });

  redrawChart();

  function redrawChart(showingRegionsIds) {
    const enabledRegionsIds = showingRegionsIds || regionsIds.filter(regionId => regions[regionId].enabled);

    const paths = linesContainer
      .selectAll('.line')
      .data(enabledRegionsIds);

    paths.exit().remove();

    paths
      .enter()
      .append('path')
      .merge(paths)
      .attr('class', 'line')
      .attr('id', regionId => `region-${ regionId }`)
      .attr('d', regionId => lineGenerator(regions[regionId].data)
      )
      .style('stroke', regionId => colorScale(regionId));

    legends.each(function(regionId) {
      const opacityValue = enabledRegionsIds.indexOf(regionId) >= 0 ? ENABLED_OPACITY : DISABLED_OPACITY;

      d3.select(this).attr('opacity', opacityValue);
    });

    const filteredData = data.filter(dataItem => enabledRegionsIds.indexOf(dataItem.regionId) >= 0);

    const voronoiPaths = voronoiGroup.selectAll('path')
      .data(voronoi.polygons(filteredData));

    voronoiPaths.exit().remove();

    voronoiPaths
      .enter()
      .append('path')
      .merge(voronoiPaths)
      .attr('d', d => (d ? `M${ d.join('L') }Z` : null))
      .on('mouseover', voronoiMouseover)
      .on('mouseout', voronoiMouseout)
      .on('click', voronoiClick);
  }

  function clickLegendHandler(regionId) {
    if (singleLineSelected) {
      const newEnabledRegions = singleLineSelected === regionId ? [] : [singleLineSelected, regionId];

      regionsIds.forEach(currentRegionId => {
        regions[currentRegionId].enabled = newEnabledRegions.indexOf(currentRegionId) >= 0;
      });
    } else {
      regions[regionId].enabled = !regions[regionId].enabled;
    }

    singleLineSelected = false;

    redrawChart();
  }

  function voronoiMouseover(d) {
    legendsDate.text(timeFormatter(d.data.date));

    legendsValues.text(dataItem => {
      const value = percentsByDate[d.data.date][dataItem];

      return value ? value + '°C' : 'N.A.';
    });

    d3.select(`#region-${ d.data.regionId }`).classed('region-hover', true);

    hoverDot
      .attr('cx', () => rescaledX(d.data.date))
      .attr('cy', () => rescaledY(d.data.percent));
  }

  function voronoiMouseout(d) {
    if (d) {
      d3.select(`#region-${ d.data.regionId }`).classed('region-hover', false);
    }
  }

  function voronoiClick(d) {
    if (singleLineSelected) {
      singleLineSelected = false;

      redrawChart();
    } else {
      const regionId = d.data.regionId;

      singleLineSelected = regionId;

      redrawChart([regionId]);
    }
  }

  function zoomed() {
    const transformation = d3.event.transform;

    const rightEdge = Math.abs(transformation.x) / transformation.k + width / transformation.k;
    const bottomEdge = Math.abs(transformation.y) / transformation.k + height / transformation.k;

    if (rightEdge > width) {
      transformation.x = -(width * transformation.k - width);
    }

    if (bottomEdge > height) {
      transformation.y = -(height * transformation.k - height);
    }

    rescaledX = transformation.rescaleX(x);
    rescaledY = transformation.rescaleY(y);

    xAxisElement.call(xAxis.scale(rescaledX));
    yAxisElement.call(yAxis.scale(rescaledY));

    linesContainer.selectAll('path')
      .attr('d', regionId => {
        return d3.line()
          .defined(d => d.percent !== 0)
          .x(d => rescaledX(d.date))
          .y(d => rescaledY(d.percent))(regions[regionId].data);
      });

    voronoiGroup
      .attr('transform', transformation);
  }
}
</script>


<h3> Insights</h3>
<ul>
<li>En los últimos 100 años la temperatura ha venido aumentando a nivel mundial, en particular ha aumentado en promedio 1 grado Celsiu, por lo tanto, el calentamiento global es una realidad. (objetivo del cliente)</li>
<li> A partir del año 2000, la temperatura en el hemisferio Norte es mucho mayor que en el hemisferio Sur, por lo tanto, los efectos del calentamiento global, en los últimos 18 años han impactado más fuerte en el hemisferio Norte con relación al hemisferio sur. Existen múltiples noticias que sooportan este insight (<a target="_blank" href="http://www.climatecentral.org/news/in-global-warming-northern-hemisphere-is-outpacing-the-south-15850"> Climate Central </a> ) 
 </li>
<li> La variabilidad de la temperatura en el hemisferior Norte es mayor con relación al hemisferio Sur. </li> 
</ul>

<h3> Referencias </h3>
<ul>
<li>NationalGeographic, consultado el 7 de Octubre de 2018, disponible en <a target="_blank" href="https://www.nationalgeographic.com/environment/global-warming/global-warming-overview/">https://www.nationalgeographic.com/environment/global-warming/global-warming-overview/</a> </li>
<li> Freecodecamp, consultado el 7 de Octubre de 2018, disponible en <a target="_blank" href="https://medium.freecodecamp.org/learn-to-create-a-line-chart-using-d3-js-4f43f1ee716b" >https://medium.freecodecamp.org/learn-to-create-a-line-chart-using-d3-js-4f43f1ee716b </a></li>
<li> itnext, consultado el 7 de Octubrede 2018, disponible en <a target="_blank" href="https://itnext.io/d3-js-in-all-its-glory-7066601aa16b">https://itnext.io/d3-js-in-all-its-glory-7066601aa16b </a></li>
<li> Learn JS Data, consultado el 7 de Octure de 2018, disponible en <a target="_blank" href="http://learnjsdata.com/group_data.html">http://learnjsdata.com/group_data.html</a></li>
<li> Data-Driven Documents, consultado el 7 de Octubre de 201, disponible en <a target="_blank" href="https://d3js.org/">https://d3js.org/ </a></li>
<li> Climate central, cosultado el 7 de Octubre de 2018, disponible en <a target="_blank" href="http://www.climatecentral.org/news/in-global-warming-northern-hemisphere-is-outpacing-the-south-15850">http://www.climatecentral.org/news/in-global-warming-northern-hemisphere-is-outpacing-the-south-15850</a> </li>


</ul>


</body>
</html>


